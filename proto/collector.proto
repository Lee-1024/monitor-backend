syntax = "proto3";

package collector;

option go_package = "monitor-backend/proto";

// Collector服务定义
service Collector {
  // 注册Agent
  rpc RegisterAgent(RegisterRequest) returns (RegisterResponse);
  
  // 上报指标数据
  rpc ReportMetrics(MetricsRequest) returns (MetricsResponse);
  
  // 心跳
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // 上报进程监控数据
  rpc ReportProcesses(ProcessReportRequest) returns (MetricsResponse);
  
  // 上报日志数据
  rpc ReportLogs(LogReportRequest) returns (MetricsResponse);
  
  // 上报脚本执行结果
  rpc ReportScriptResult(ScriptResultRequest) returns (MetricsResponse);
  
  // 上报服务状态
  rpc ReportServiceStatus(ServiceStatusRequest) returns (MetricsResponse);
}

// 注册请求
message RegisterRequest {
  string host_id = 1;
  string hostname = 2;
  string ip = 3;
  string os = 4;
  string arch = 5;
  map<string, string> tags = 6;
}

// 注册响应
message RegisterResponse {
  bool success = 1;
  string message = 2;
  int64 collect_interval = 3;
}

// 指标上报请求
message MetricsRequest {
  string host_id = 1;
  int64 timestamp = 2;
  
  CPUMetrics cpu = 3;
  MemoryMetrics memory = 4;
  DiskMetrics disk = 5;
  NetworkMetrics network = 6;
}

// CPU指标
message CPUMetrics {
  double usage_percent = 1;
  double load_avg_1 = 2;
  double load_avg_5 = 3;
  double load_avg_15 = 4;
  int32 core_count = 5;
}

// 内存指标
message MemoryMetrics {
  uint64 total = 1;
  uint64 used = 2;
  uint64 free = 3;
  double used_percent = 4;
  uint64 available = 5;
}

// 磁盘指标
message DiskMetrics {
  repeated PartitionMetrics partitions = 1;
}

// 分区指标
message PartitionMetrics {
  string device = 1;
  string mountpoint = 2;
  string fstype = 3;
  uint64 total = 4;
  uint64 used = 5;
  uint64 free = 6;
  double used_percent = 7;
}

// 网络指标
message NetworkMetrics {
  repeated InterfaceMetrics interfaces = 1;
}

// 网卡指标
message InterfaceMetrics {
  string name = 1;
  uint64 bytes_sent = 2;
  uint64 bytes_recv = 3;
  uint64 packets_sent = 4;
  uint64 packets_recv = 5;
  uint64 errin = 6;
  uint64 errout = 7;
}

// 指标上报响应
message MetricsResponse {
  bool success = 1;
  string message = 2;
}

// 心跳请求
message HeartbeatRequest {
  string host_id = 1;
  int64 timestamp = 2;
}

// 心跳响应
message HeartbeatResponse {
  bool success = 1;
  int64 server_time = 2;
}

// 进程监控上报请求
message ProcessReportRequest {
  string host_id = 1;
  int64 timestamp = 2;
  repeated ProcessInfo processes = 3;
}

// 进程信息
message ProcessInfo {
  int32 pid = 1;
  string name = 2;
  string user = 3;
  double cpu_percent = 4;
  double memory_percent = 5;
  uint64 memory_bytes = 6;
  int64 create_time = 7;
  string status = 8;
  string command = 9;
}

// 日志上报请求
message LogReportRequest {
  string host_id = 1;
  int64 timestamp = 2;
  repeated LogEntry logs = 3;
}

// 日志条目
message LogEntry {
  string source = 1;        // 日志来源（文件路径或服务名）
  string level = 2;         // 日志级别（INFO, WARN, ERROR等）
  string message = 3;      // 日志内容
  int64 timestamp = 4;      // 日志时间戳
  map<string, string> tags = 5;  // 额外标签
}

// 脚本执行结果上报请求
message ScriptResultRequest {
  string host_id = 1;
  string script_id = 2;     // 脚本ID
  string script_name = 3;   // 脚本名称
  int64 timestamp = 4;
  bool success = 5;         // 执行是否成功
  string output = 6;        // 标准输出
  string error = 7;         // 错误输出
  int32 exit_code = 8;     // 退出码
  int64 duration_ms = 9;   // 执行耗时（毫秒）
}

// 服务状态上报请求
message ServiceStatusRequest {
  string host_id = 1;
  int64 timestamp = 2;
  repeated ServiceInfo services = 3;
}

// 服务信息
message ServiceInfo {
  string name = 1;         // 服务名称
  string status = 2;        // 状态（running, stopped, failed等）
  bool enabled = 3;        // 是否开机自启
  string description = 4;   // 服务描述
  int64 uptime_seconds = 5; // 运行时长（秒）
  int32 port = 6;          // 服务端口（可选，用于端口检查）
  bool port_accessible = 7; // 端口是否可访问（可选，用于端口检查结果）
}
