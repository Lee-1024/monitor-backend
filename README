// ============================================
// 目录结构
// ============================================
/*
monitor-backend/
├── main.go
├── config.go
├── service.go
├── storage.go
├── storage_adapter.go  (新增)
├── models.go
├── api/
│   ├── server.go       (新增)
│   ├── handlers.go     (新增)
│   └── storage_interface.go (新增)
├── proto/
│   ├── collector.proto
│   ├── collector.pb.go
│   └── collector_grpc.pb.go
├── config.yaml
├── go.mod
└── go.sum
*/

// ============================================
// 依赖说明
// ============================================
/*
需要安装的依赖：
go get google.golang.org/grpc
go get google.golang.org/protobuf
go get github.com/influxdata/influxdb-client-go/v2
go get gorm.io/gorm
go get gorm.io/driver/postgres
go get github.com/redis/go-redis/v9
go get gopkg.in/yaml.v3

生成protobuf代码：
protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    proto/collector.proto

go.mod 内容：
module monitor-backend

go 1.21

require (
    google.golang.org/grpc v1.60.0
    google.golang.org/protobuf v1.31.0
    github.com/influxdata/influxdb-client-go/v2 v2.13.0
    gorm.io/gorm v1.25.5
    gorm.io/driver/postgres v1.5.4
    github.com/redis/go-redis/v9 v9.3.0
    gopkg.in/yaml.v3 v3.0.1
)
*/

# 1. 确保数据库运行
docker-compose ps

# 2. 启动后端（同时启动gRPC和HTTP）
cd monitor-backend
go run .

# 3. 启动Agent
cd monitor-agent
go run . -server localhost:50051 -host-id server-001

# 4. 测试HTTP API
curl http://localhost:8080/health
curl http://localhost:8080/api/v1/agents
curl http://localhost:8080/api/v1/metrics/latest?host_id=server-001
curl http://localhost:8080/api/v1/stats/overview